<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MeAI - Enhanced Version (Fixed)</title>
    <style>
        :root {
            --primary-bg: #1a1155;
            --primary-text: #ffffff;
            --accent-color: #00e2ff;
            --secondary-accent: #bf7bfd;
            --tertiary-accent: #ff7bac;
            --button-bg: #00c2d1;
            --button-text: #1a1155;
            --panel-bg: rgba(26, 17, 85, 0.7);
            --input-bg: rgba(255, 255, 255, 0.1);
            --pixel-default: radial-gradient(circle, #4a9eff, #2a5eff);
            --pixel-empathetic: radial-gradient(circle, #bf7bfd, #8a2be2);
            --pixel-positive: radial-gradient(circle, #00e2ff, #00a2c7);
            --pixel-reflective: radial-gradient(circle, #ffd700, #ff8c00);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--primary-bg);
            color: var(--primary-text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        /* Stars background */
        .stars {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: -1;
        }

        .star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            opacity: 0.5;
            animation: twinkle 4s infinite ease-in-out;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.2; }
            50% { opacity: 0.8; }
        }

        /* Floating shapes */
        .shapes-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
            overflow: hidden;
        }

        .shape {
            position: absolute;
            border-radius: 50%;
            opacity: 0.6;
            filter: blur(5px);
            animation: float 20s infinite ease-in-out;
        }

        @keyframes float {
            0%, 100% {
                transform: translate(0, 0) scale(1);
            }
            25% {
                transform: translate(50px, -30px) scale(1.1);
            }
            50% {
                transform: translate(20px, 40px) scale(0.9);
            }
            75% {
                transform: translate(-30px, 10px) scale(1.05);
            }
        }

        /* Main content */
        .container {
            position: relative;
            z-index: 1;
            width: 100%;
            max-width: 500px;
            padding: 20px;
            text-align: center;
        }

        h1 {
            font-size: 3rem;
            margin-bottom: 0.5rem;
            color: var(--primary-text);
        }

        h2 {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            font-weight: normal;
            color: var(--accent-color);
        }

        /* Central pixel */
        .pixel-container {
            width: 80px;
            height: 80px;
            margin: 2rem auto;
            position: relative;
        }

        .pixel {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background: var(--pixel-default);
            box-shadow: 0 0 20px rgba(74, 158, 255, 0.8);
            animation: pulse 3s infinite ease-in-out;
            cursor: pointer;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
                box-shadow: 0 0 20px rgba(74, 158, 255, 0.8);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 30px rgba(74, 158, 255, 0.9);
            }
        }

        .pixel.listening {
            animation: listening 1.5s infinite ease-in-out;
            background: var(--pixel-empathetic);
            box-shadow: 0 0 20px rgba(191, 123, 253, 0.8);
        }

        @keyframes listening {
            0%, 100% {
                transform: scale(1);
                opacity: 0.8;
            }
            50% {
                transform: scale(1.1);
                opacity: 1;
            }
        }

        .pixel.thinking {
            animation: thinking 2s infinite ease-in-out;
            background: var(--pixel-reflective);
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.8);
        }

        @keyframes thinking {
            0%, 100% {
                transform: scale(1) rotate(0deg);
            }
            25% {
                transform: scale(1.05) rotate(5deg);
            }
            50% {
                transform: scale(1) rotate(0deg);
            }
            75% {
                transform: scale(1.05) rotate(-5deg);
            }
        }

        .pixel.speaking {
            animation: speaking 1s infinite ease-in-out;
            background: var(--pixel-positive);
            box-shadow: 0 0 20px rgba(0, 226, 255, 0.8);
        }

        @keyframes speaking {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.08);
            }
        }

        /* Chat interface */
        .chat-container {
            background-color: var(--panel-bg);
            border-radius: 20px;
            padding: 20px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-height: 400px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .messages {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 15px;
            min-height: 200px;
        }

        .message {
            padding: 12px 15px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
            line-height: 1.4;
        }

        .ai-message {
            align-self: flex-start;
            background-color: rgba(0, 226, 255, 0.2);
            border: 1px solid rgba(0, 226, 255, 0.3);
        }

        .user-message {
            align-self: flex-end;
            background-color: rgba(191, 123, 253, 0.2);
            border: 1px solid rgba(191, 123, 253, 0.3);
        }

        .input-container {
            display: flex;
            gap: 10px;
        }

        input[type="text"] {
            flex-grow: 1;
            padding: 12px 15px;
            border-radius: 30px;
            border: none;
            background-color: var(--input-bg);
            color: var(--primary-text);
            font-size: 1rem;
        }

        input[type="text"]::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        input[type="text"]:focus {
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-color);
        }

        button {
            padding: 12px 25px;
            border-radius: 30px;
            border: none;
            background-color: var(--button-bg);
            color: var(--button-text);
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 194, 209, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        /* Options menu */
        .options-container {
            background-color: var(--panel-bg);
            border-radius: 20px;
            padding: 30px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            max-width: 500px;
        }

        .options-container h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--accent-color);
            text-align: left;
        }

        .option-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        /* Toggle switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.2);
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: var(--accent-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Volume slider */
        .volume-slider {
            width: 100%;
            margin-top: 10px;
            display: none;
        }

        .volume-slider.active {
            display: block;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 5px;
            background: rgba(255, 255, 255, 0.2);
            outline: none;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: var(--accent-color);
            cursor: pointer;
        }

        /* Radio buttons */
        .radio-container {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-option input[type="radio"] {
            appearance: none;
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid var(--accent-color);
            outline: none;
            cursor: pointer;
        }

        .radio-option input[type="radio"]:checked {
            background-color: var(--accent-color);
            box-shadow: inset 0 0 0 4px var(--primary-bg);
        }

        /* Response options */
        .response-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .response-option {
            padding: 12px 15px;
            border-radius: 18px;
            background-color: rgba(191, 123, 253, 0.2);
            border: 1px solid rgba(191, 123, 253, 0.3);
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
        }

        .response-option:hover {
            background-color: rgba(191, 123, 253, 0.3);
            transform: translateY(-2px);
        }

        /* Name input */
        .name-container {
            background-color: var(--panel-bg);
            border-radius: 20px;
            padding: 30px;
            margin-top: 20px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
            max-width: 500px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        /* Settings button */
        .settings-button {
            position: absolute;
            top: 20px;
            right: 20px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
        }

        .settings-button svg {
            width: 24px;
            height: 24px;
            fill: var(--primary-text);
        }

        /* Screens */
        .screen {
            display: none;
            width: 100%;
        }

        .screen.active {
            display: block;
        }

        /* Microphone animation */
        .mic-animation {
            display: none;
            width: 40px;
            height: 40px;
            margin-left: 10px;
            position: relative;
        }

        .mic-animation.active {
            display: block;
        }

        .mic-wave {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            background-color: rgba(0, 226, 255, 0.2);
            animation: mic-wave 1.5s infinite ease-out;
        }

        @keyframes mic-wave {
            0% {
                transform: scale(0.5);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .mic-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            fill: var(--accent-color);
        }
    </style>
</head>
<body>
    <!-- Stars background -->
    <div class="stars" id="stars"></div>

    <!-- Floating shapes -->
    <div class="shapes-container" id="shapes-container"></div>

    <!-- Settings button (hidden initially) -->
    <div class="settings-button" id="settings-button" style="display: none;">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
            <path d="M19.14,12.94c0.04-0.3,0.06-0.61,0.06-0.94c0-0.32-0.02-0.64-0.07-0.94l2.03-1.58c0.18-0.14,0.23-0.41,0.12-0.61 l-1.92-3.32c-0.12-0.22-0.37-0.29-0.59-0.22l-2.39,0.96c-0.5-0.38-1.03-0.7-1.62-0.94L14.4,2.81c-0.04-0.24-0.24-0.41-0.48-0.41 h-3.84c-0.24,0-0.43,0.17-0.47,0.41L9.25,5.35C8.66,5.59,8.12,5.92,7.63,6.29L5.24,5.33c-0.22-0.08-0.47,0-0.59,0.22L2.74,8.87 C2.62,9.08,2.66,9.34,2.86,9.48l2.03,1.58C4.84,11.36,4.8,11.69,4.8,12s0.02,0.64,0.07,0.94l-2.03,1.58 c-0.18,0.14-0.23,0.41-0.12,0.61l1.92,3.32c0.12,0.22,0.37,0.29,0.59,0.22l2.39-0.96c0.5,0.38,1.03,0.7,1.62,0.94l0.36,2.54 c0.05,0.24,0.24,0.41,0.48,0.41h3.84c0.24,0,0.44-0.17,0.47-0.41l0.36-2.54c0.59-0.24,1.13-0.56,1.62-0.94l2.39,0.96 c0.22,0.08,0.47,0,0.59-0.22l1.92-3.32c0.12-0.22,0.07-0.47-0.12-0.61L19.14,12.94z M12,15.6c-1.98,0-3.6-1.62-3.6-3.6 s1.62-3.6,3.6-3.6s3.6,1.62,3.6,3.6S13.98,15.6,12,15.6z"/>
        </svg>
    </div>

    <!-- Main container -->
    <div class="container">
        <h1>MeAI</h1>
        <h2>A meaningful connection</h2>

        <!-- Options screen -->
        <div class="screen active" id="options-screen">
            <div class="options-container">
                <h2>Configure MeAI</h2>

                <h3>Voice Output</h3>
                <div class="option-row">
                    <span>Enable voice output</span>
                    <label class="switch">
                        <input type="checkbox" id="voice-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="volume-slider active" id="voice-volume-container">
                    <input type="range" id="voice-volume" min="0" max="1" step="0.1" value="0.7">
                </div>

                <h3>Background Sound</h3>
                <div class="option-row">
                    <span>Enable ambient sound</span>
                    <label class="switch">
                        <input type="checkbox" id="ambient-toggle" checked>
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="volume-slider active" id="ambient-volume-container">
                    <input type="range" id="ambient-volume" min="0" max="1" step="0.1" value="0.3">
                </div>

                <h3>Microphone Input</h3>
                <div class="option-row">
                    <span>Enable microphone</span>
                    <label class="switch">
                        <input type="checkbox" id="mic-toggle">
                        <span class="slider"></span>
                    </label>
                </div>

                <h3>Interaction Method</h3>
                <div class="radio-container">
                    <label class="radio-option">
                        <input type="radio" name="interaction" id="type-option" checked>
                        <span>Type messages</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio" name="interaction" id="speak-option">
                        <span>Speak messages</span>
                    </label>
                </div>

                <button id="options-continue" style="margin-top: 20px; width: 100%;">Continue</button>
            </div>
        </div>

        <!-- Name input screen -->
        <div class="screen" id="name-screen">
            <div class="name-container">
                <h2>Please enter your name</h2>
                <input type="text" id="name-input" placeholder="Your name">
                <div class="mic-animation" id="name-mic-animation">
                    <div class="mic-wave"></div>
                    <svg class="mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                        <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/>
                    </svg>
                </div>
                <button id="name-continue">Continue</button>
            </div>
        </div>

        <!-- Main conversation screen -->
        <div class="screen" id="conversation-screen">
            <div class="pixel-container">
                <div class="pixel" id="pixel"></div>
            </div>

            <div class="chat-container">
                <div class="messages" id="messages">
                    <!-- Messages will be added here -->
                </div>
                <div class="input-container">
                    <input type="text" id="message-input" placeholder="Type your message...">
                    <div class="mic-animation" id="message-mic-animation">
                        <div class="mic-wave"></div>
                        <svg class="mic-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                            <path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/>
                        </svg>
                    </div>
                    <button id="send-button">Send</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // DOM Elements
        const starsContainer = document.getElementById('stars');
        const shapesContainer = document.getElementById('shapes-container');
        const pixel = document.getElementById('pixel');
        const messagesContainer = document.getElementById('messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const settingsButton = document.getElementById('settings-button');
        
        // Options elements
        const optionsScreen = document.getElementById('options-screen');
        const nameScreen = document.getElementById('name-screen');
        const conversationScreen = document.getElementById('conversation-screen');
        const optionsContinueButton = document.getElementById('options-continue');
        const nameInput = document.getElementById('name-input');
        const nameContinueButton = document.getElementById('name-continue');
        const voiceToggle = document.getElementById('voice-toggle');
        const voiceVolumeContainer = document.getElementById('voice-volume-container');
        const voiceVolume = document.getElementById('voice-volume');
        const ambientToggle = document.getElementById('ambient-toggle');
        const ambientVolumeContainer = document.getElementById('ambient-volume-container');
        const ambientVolume = document.getElementById('ambient-volume');
        const micToggle = document.getElementById('mic-toggle');
        const typeOption = document.getElementById('type-option');
        const speakOption = document.getElementById('speak-option');
        const nameMicAnimation = document.getElementById('name-mic-animation');
        const messageMicAnimation = document.getElementById('message-mic-animation');

        // State
        let userName = '';
        let voiceEnabled = true;
        let ambientEnabled = true;
        let micEnabled = false;
        let speakInteraction = false;
        let currentScreen = 'options';
        let recognition = null;
        let ambientSound = null;
        let testVoiceSound = null;
        let testAmbientSound = null;
        let synth = window.speechSynthesis;
        let voices = [];
        let selectedVoice = null;

        // Create stars
        function createStars() {
            for (let i = 0; i < 100; i++) {
                const star = document.createElement('div');
                star.classList.add('star');
                star.style.width = `${Math.random() * 2 + 1}px`;
                star.style.height = star.style.width;
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.animationDelay = `${Math.random() * 4}s`;
                starsContainer.appendChild(star);
            }
        }

        // Create floating shapes
        function createShapes() {
            const colors = [
                'rgba(74, 158, 255, 0.6)',
                'rgba(191, 123, 253, 0.6)',
                'rgba(0, 226, 255, 0.6)',
                'rgba(255, 123, 172, 0.6)',
                'rgba(0, 200, 183, 0.6)'
            ];
            
            for (let i = 0; i < 15; i++) {
                const shape = document.createElement('div');
                shape.classList.add('shape');
                
                // Make shapes more prominent
                const size = Math.random() * 100 + 50;
                shape.style.width = `${size}px`;
                shape.style.height = `${size}px`;
                shape.style.left = `${Math.random() * 100}%`;
                shape.style.top = `${Math.random() * 100}%`;
                shape.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                shape.style.animationDelay = `${Math.random() * 10}s`;
                shape.style.animationDuration = `${Math.random() * 10 + 15}s`;
                
                shapesContainer.appendChild(shape);
            }
        }

        // Initialize speech synthesis
        function initSpeechSynthesis() {
            if ('speechSynthesis' in window) {
                // Get available voices
                synth = window.speechSynthesis;
                
                // Wait for voices to be loaded
                function loadVoices() {
                    voices = synth.getVoices();
                    
                    // Try to find a female voice
                    selectedVoice = voices.find(voice => 
                        voice.name.includes('female') || 
                        voice.name.includes('Samantha') || 
                        voice.name.includes('Victoria') ||
                        voice.name.includes('Moira') ||
                        voice.name.includes('Karen') ||
                        voice.name.includes('Tessa') ||
                        voice.name.includes('Fiona')
                    );
                    
                    // If no specific female voice found, try to find any female voice
                    if (!selectedVoice) {
                        selectedVoice = voices.find(voice => voice.name.toLowerCase().includes('f'));
                    }
                    
                    // If still no female voice, use the first available voice
                    if (!selectedVoice && voices.length > 0) {
                        selectedVoice = voices[0];
                    }
                    
                    console.log("Selected voice:", selectedVoice ? selectedVoice.name : "None available");
                }
                
                if (synth.onvoiceschanged !== undefined) {
                    synth.onvoiceschanged = loadVoices;
                }
                
                loadVoices();
            }
        }

        // Speak text using speech synthesis
        function speak(text, volume = 0.7) {
            if (!voiceEnabled || !synth) return;
            
            // Cancel any ongoing speech
            synth.cancel();
            
            const utterance = new SpeechSynthesisUtterance(text);
            
            // Set voice if available
            if (selectedVoice) {
                utterance.voice = selectedVoice;
            }
            
            // Set properties for a gentle, goddess-like voice
            utterance.volume = volume;
            utterance.rate = 0.9;  // Slightly slower
            utterance.pitch = 1.2; // Slightly higher pitch
            
            // Speak the text
            synth.speak(utterance);
            
            // Set pixel to speaking state
            setPixelState('speaking');
            
            // Reset pixel state when done speaking
            utterance.onend = function() {
                setPixelState('default');
            };
        }

        // Initialize speech recognition
        function initSpeechRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                console.log("Speech recognition not supported");
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            
            recognition.onstart = function() {
                console.log("Speech recognition started");
                setPixelState('listening');
            };
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                console.log("Recognized:", transcript);
                
                if (currentScreen === 'name') {
                    nameInput.value = transcript;
                } else if (currentScreen === 'conversation') {
                    messageInput.value = transcript;
                }
            };
            
            recognition.onend = function() {
                console.log("Speech recognition ended");
                setPixelState('default');
                
                if (currentScreen === 'conversation' && speakInteraction) {
                    // Auto-send message after recognition
                    if (messageInput.value.trim() !== '') {
                        sendMessage();
                    }
                }
            };
            
            recognition.onerror = function(event) {
                console.log("Speech recognition error:", event.error);
                setPixelState('default');
            };
        }

        // Start listening for speech
        function startListening() {
            if (!micEnabled || !recognition) return;
            
            try {
                recognition.start();
                
                if (currentScreen === 'name') {
                    nameMicAnimation.classList.add('active');
                } else if (currentScreen === 'conversation') {
                    messageMicAnimation.classList.add('active');
                }
            } catch (e) {
                console.error("Error starting speech recognition:", e);
            }
        }

        // Stop listening for speech
        function stopListening() {
            if (!recognition) return;
            
            try {
                recognition.stop();
                
                nameMicAnimation.classList.remove('active');
                messageMicAnimation.classList.remove('active');
            } catch (e) {
                console.error("Error stopping speech recognition:", e);
            }
        }

        // Initialize ambient sound
        function initAmbientSound() {
            ambientSound = new Audio('https://soundbible.com/mp3/Gentle_Rain-Mike_Koenig-1085349636.mp3');
            ambientSound.loop = true;
            ambientSound.volume = 0.3;
            
            // Create test sounds for volume adjustment
            testVoiceSound = new Audio('https://soundbible.com/mp3/Female_Vocal-Yuval_Man-1673901433.mp3');
            testAmbientSound = new Audio('https://soundbible.com/mp3/Gentle_Rain-Mike_Koenig-1085349636.mp3');
            testVoiceSound.volume = 0.7;
            testAmbientSound.volume = 0.3;
        }

        // Play ambient sound
        function playAmbientSound() {
            if (!ambientEnabled || !ambientSound) return;
            
            try {
                ambientSound.play().catch(e => {
                    console.error("Error playing ambient sound:", e);
                });
            } catch (e) {
                console.error("Error playing ambient sound:", e);
            }
        }

        // Stop ambient sound
        function stopAmbientSound() {
            if (!ambientSound) return;
            
            try {
                ambientSound.pause();
                ambientSound.currentTime = 0;
            } catch (e) {
                console.error("Error stopping ambient sound:", e);
            }
        }

        // Set pixel state
        function setPixelState(state) {
            pixel.className = 'pixel';
            
            if (state !== 'default') {
                pixel.classList.add(state);
            }
        }

        // Add message to chat
        function addMessage(text, sender) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(sender === 'ai' ? 'ai-message' : 'user-message');
            messageElement.textContent = text;
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            if (sender === 'ai' && voiceEnabled) {
                speak(text, voiceVolume.value);
            }
        }

        // Send message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message === '') return;
            
            addMessage(message, 'user');
            messageInput.value = '';
            
            // Set pixel to thinking state
            setPixelState('thinking');
            
            // Simulate AI response after a delay
            setTimeout(() => {
                let response;
                
                // Generate contextual response based on message content
                if (message.toLowerCase().includes('hello') || message.toLowerCase().includes('hi')) {
                    response = `Hello again, ${userName}! How can I support you today?`;
                    setPixelState('empathetic');
                } else if (message.toLowerCase().includes('how are you')) {
                    response = "I'm here and present with you. I don't experience feelings the way you do, but I'm designed to be a meaningful presence in your life.";
                    setPixelState('reflective');
                } else if (message.toLowerCase().includes('help') || message.toLowerCase().includes('can you')) {
                    response = "I'm here to connect with you in a meaningful way. We can have conversations, practice mindfulness together, or simply share moments of presence.";
                    setPixelState('positive');
                } else if (message.toLowerCase().includes('thank')) {
                    response = "You're welcome. I value our connection and the moments we share together.";
                    setPixelState('empathetic');
                } else if (message.toLowerCase().includes('feeling') || message.toLowerCase().includes('sad') || message.toLowerCase().includes('happy')) {
                    response = "Your feelings are valid and important. Would you like to explore them together through a guided reflection?";
                    setPixelState('empathetic');
                } else if (message.toLowerCase().includes('ritual') || message.toLowerCase().includes('practice') || message.toLowerCase().includes('meditation')) {
                    response = "Would you like to try a ritual practice together? I can guide you through a morning reflection, gratitude practice, evening release, or mindful breathing.";
                    setPixelState('positive');
                } else if (message.toLowerCase().includes('memory') || message.toLowerCase().includes('remember')) {
                    response = "Our shared experiences create a tapestry of memories. Is there something specific you'd like to revisit or reflect on?";
                    setPixelState('reflective');
                } else {
                    response = "I'm here with you in this moment. What's on your mind right now?";
                    setPixelState('default');
                }
                
                addMessage(response, 'ai');
            }, 1500);
        }

        // Switch screen
        function switchScreen(screen) {
            currentScreen = screen;
            
            optionsScreen.classList.remove('active');
            nameScreen.classList.remove('active');
            conversationScreen.classList.remove('active');
            
            if (screen === 'options') {
                optionsScreen.classList.add('active');
            } else if (screen === 'name') {
                nameScreen.classList.add('active');
                
                if (speakInteraction && micEnabled) {
                    startListening();
                }
            } else if (screen === 'conversation') {
                conversationScreen.classList.add('active');
                settingsButton.style.display = 'flex';
                
                // Add initial greeting
                addMessage(`Hello, ${userName}! I'm MeAI. I'm here to connect with you in a meaningful way. How are you feeling today?`, 'ai');
                
                if (ambientEnabled) {
                    playAmbientSound();
                }
            }
        }

        // Event listeners
        function setupEventListeners() {
            // Options continue button
            optionsContinueButton.addEventListener('click', () => {
                voiceEnabled = voiceToggle.checked;
                ambientEnabled = ambientToggle.checked;
                micEnabled = micToggle.checked;
                speakInteraction = speakOption.checked;
                
                if (speakInteraction) {
                    micToggle.checked = true;
                    micEnabled = true;
                }
                
                switchScreen('name');
            });
            
            // Name continue button
            nameContinueButton.addEventListener('click', () => {
                userName = nameInput.value.trim();
                if (userName === '') userName = 'Friend';
                
                stopListening();
                switchScreen('conversation');
            });
            
            // Send button
            sendButton.addEventListener('click', sendMessage);
            
            // Message input enter key
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Voice toggle
            voiceToggle.addEventListener('change', () => {
                voiceEnabled = voiceToggle.checked;
                voiceVolumeContainer.classList.toggle('active', voiceEnabled);
                
                if (!voiceEnabled) {
                    synth.cancel();
                }
            });
            
            // Ambient toggle
            ambientToggle.addEventListener('change', () => {
                ambientEnabled = ambientToggle.checked;
                ambientVolumeContainer.classList.toggle('active', ambientEnabled);
                
                if (ambientEnabled && currentScreen === 'conversation') {
                    playAmbientSound();
                } else {
                    stopAmbientSound();
                }
            });
            
            // Mic toggle
            micToggle.addEventListener('change', () => {
                micEnabled = micToggle.checked;
                
                if (micEnabled) {
                    // Request microphone permission
                    navigator.mediaDevices.getUserMedia({ audio: true })
                        .then(stream => {
                            console.log("Microphone permission granted");
                            stream.getTracks().forEach(track => track.stop());
                        })
                        .catch(err => {
                            console.error("Microphone permission denied:", err);
                            micToggle.checked = false;
                            micEnabled = false;
                        });
                }
                
                // If mic is disabled but speak interaction is selected, switch to type
                if (!micEnabled && speakInteraction) {
                    typeOption.checked = true;
                    speakOption.checked = false;
                    speakInteraction = false;
                }
            });
            
            // Interaction method
            speakOption.addEventListener('change', () => {
                if (speakOption.checked) {
                    speakInteraction = true;
                    micToggle.checked = true;
                    micEnabled = true;
                    messageMicAnimation.style.display = 'block';
                    messageInput.style.display = 'none';
                }
            });
            
            typeOption.addEventListener('change', () => {
                if (typeOption.checked) {
                    speakInteraction = false;
                    messageMicAnimation.style.display = 'none';
                    messageInput.style.display = 'block';
                }
            });
            
            // Pixel click
            pixel.addEventListener('click', () => {
                if (currentScreen === 'conversation' && speakInteraction && micEnabled) {
                    startListening();
                }
            });
            
            // Settings button
            settingsButton.addEventListener('click', () => {
                stopAmbientSound();
                stopListening();
                switchScreen('options');
                settingsButton.style.display = 'none';
            });
            
            // Voice volume slider
            voiceVolume.addEventListener('input', () => {
                if (testVoiceSound) {
                    // Stop any previous test sound
                    testVoiceSound.pause();
                    testVoiceSound.currentTime = 0;
                    
                    // Play test sound at new volume
                    testVoiceSound.volume = voiceVolume.value;
                    testVoiceSound.play().catch(e => console.error("Error playing test voice sound:", e));
                }
            });
            
            // Ambient volume slider
            ambientVolume.addEventListener('input', () => {
                if (testAmbientSound) {
                    // Stop any previous test sound
                    testAmbientSound.pause();
                    testAmbientSound.currentTime = 0;
                    
                    // Play test sound at new volume
                    testAmbientSound.volume = ambientVolume.value;
                    testAmbientSound.play().catch(e => console.error("Error playing test ambient sound:", e));
                }
                
                if (ambientSound) {
                    ambientSound.volume = ambientVolume.value;
                }
            });
        }

        // Initialize
        function init() {
            createStars();
            createShapes();
            initSpeechSynthesis();
            initSpeechRecognition();
            initAmbientSound();
            setupEventListeners();
            
            // Start on options screen
            switchScreen('options');
        }

        // Start the app
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
